---
- name: Configure logrotate for Plesk PHP-FPM if needed
  hosts: all
  become: yes
  vars:
    logrotate_dir: /etc/logrotate.d
    plesk_logrotate_conf: /etc/logrotate.plesk-php.conf

  tasks:
    - name: Find existing plesk-php*-fpm logrotate files
      find:
        paths: "{{ logrotate_dir }}"
        patterns: "plesk-php*-fpm"
        file_type: file
      register: fpm_files

    - name: Find existing plesk-php* logrotate files excluding *-fpm
      find:
        paths: "{{ logrotate_dir }}"
        patterns: "plesk-php*"
        file_type: file
      register: php_files

    - name: Filter plesk-php files excluding those with -fpm suffix
      set_fact:
        non_fpm_php_files: "{{ php_files.files | map(attribute='path') | reject('search', '-fpm') | list }}"

    - name: Extract base names without path for non-fpm files
      set_fact:
        non_fpm_bases: "{{ non_fpm_php_files | map('regex_replace', '^.*/', '') | list }}"

    - name: Extract base names for existing fpm files without path and '-fpm' suffix
      set_fact:
        fpm_bases: >-
          {{
            fpm_files.files
            | map(attribute='path')
            | map('regex_replace', '^.*/', '')
            | map('regex_replace', '-fpm$', '')
            | list
          }}

    - name: Determine missing fpm files to create
      set_fact:
        missing_fpm_bases: "{{ non_fpm_bases | difference(fpm_bases) }}"

    - name: Create plesk-php*-fpm logrotate files if missing
      copy:
        dest: "{{ logrotate_dir }}/{{ item }}-fpm"
        content: |
          /var/log/{{ item }}-fpm/*log {
              daily
              missingok
              notifempty
              sharedscripts
              delaycompress
              dateext
              dateformat -%Y%m%d
              rotate 7
              compress
              create 640 root root
              postrotate
                  /bin/kill -SIGUSR1 `cat /run/{{ item }}-fpm.pid 2>/dev/null` 2>/dev/null || true
              endscript
          }
        owner: root
        group: root
        mode: '0640'
      loop: "{{ missing_fpm_bases }}"
      when: missing_fpm_bases | length > 0

    - name: Refresh fpm_files list including newly created files
      find:
        paths: "{{ logrotate_dir }}"
        patterns: "plesk-php*-fpm"
        file_type: file
      register: fpm_files_updated

    - name: Extract full paths of all plesk-php*-fpm files
      set_fact:
        logrotate_php_fpm_files: "{{ fpm_files_updated.files | map(attribute='path') | list }}"

    - name: Create logrotate include config for Plesk PHP-FPM if files found
      copy:
        dest: "{{ plesk_logrotate_conf }}"
        content: |
          {% for file in logrotate_php_fpm_files %}
          include {{ file }}
          {% endfor %}
        owner: root
        group: root
        mode: '0644'
      when: logrotate_php_fpm_files | length > 0

    - name: Remove logrotate include config if no plesk-php-fpm files found
      file:
        path: "{{ plesk_logrotate_conf }}"
        state: absent
      when: logrotate_php_fpm_files | length == 0

    - name: Create systemd service file if fpm files found
      copy:
        dest: /etc/systemd/system/logrotate-plesk-php-fpm.service
        content: |
          [Unit]
          Description=Logrotate for Plesk PHP-FPM

          [Service]
          Type=oneshot
          ExecStart=/usr/sbin/logrotate {{ plesk_logrotate_conf }}
        owner: root
        group: root
        mode: '0644'
      when: logrotate_php_fpm_files | length > 0

    - name: Remove systemd service file if no fpm files found
      file:
        path: /etc/systemd/system/logrotate-plesk-php-fpm.service
        state: absent
      when: logrotate_php_fpm_files | length == 0

    - name: Create systemd timer file if fpm files found
      copy:
        dest: /etc/systemd/system/logrotate-plesk-php-fpm.timer
        content: |
          [Unit]
          Description=Daily log rotation for Plesk PHP-FPM

          [Timer]
          OnCalendar=daily
          Persistent=true

          [Install]
          WantedBy=timers.target
        owner: root
        group: root
        mode: '0644'
      when: logrotate_php_fpm_files | length > 0

    - name: Remove systemd timer file if no fpm files found
      file:
        path: /etc/systemd/system/logrotate-plesk-php-fpm.timer
        state: absent
      when: logrotate_php_fpm_files | length == 0

    - name: Reload systemd to recognize new/removed units if files found or removed
      command: systemctl daemon-reload
      changed_when: false
      when: true

    - name: Enable and start logrotate timer if fpm files found
      systemd:
        name: logrotate-plesk-php-fpm.timer
        enabled: yes
        state: started
      when: logrotate_php_fpm_files | length > 0

    - name: Disable and stop logrotate timer if no fpm files found
      systemd:
        name: logrotate-plesk-php-fpm.timer
        enabled: no
        state: stopped
      when: logrotate_php_fpm_files | length == 0
