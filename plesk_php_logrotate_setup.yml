- name: Configure logrotate for Plesk PHP-FPM if needed
  hosts: all
  become: yes
  tasks:

    - name: Find plesk-php*-fpm logrotate files
      find:
        paths: /etc/logrotate.d
        patterns: 'plesk-php*-fpm'
      register: fpm_files

    - name: Find plesk-php* logrotate files excluding -fpm
      find:
        paths: /etc/logrotate.d
        patterns: 'plesk-php*'
      register: php_files

    - name: Filter plesk-php files excluding those with -fpm in name
      set_fact:
        non_fpm_php_files: >-
          {{ php_files.files | map(attribute='path') | reject('search', '-fpm') | list }}

    - name: Extract base php names without path for non-fpm files
      set_fact:
        non_fpm_bases: "{{ non_fpm_php_files | map('basename') | list }}"

    - name: Extract base php-fpm names without path and -fpm suffix
      set_fact:
        fpm_bases: >-
          {{ fpm_files.files
             | map(attribute='path')
             | map('basename')
             | map('regex_replace', '-fpm$', '')
             | list }}

    - name: Determine missing fpm files to create
      set_fact:
        missing_fpm_bases: >-
          {{ non_fpm_bases | difference(fpm_bases) }}

    - name: Compose full path of missing fpm files
      set_fact:
        needed_fpm_files: >-
          {{ missing_fpm_bases | map('regex_replace', '^(plesk-php[0-9]+)$', '/etc/logrotate.d/\\1-fpm') | list }}

    - name: Create plesk-php*-fpm logrotate files if missing
      copy:
        dest: "{{ item }}"
        content: |
          /var/log/{{ item | basename }}/*log {
              daily
              missingok
              notifempty
              sharedscripts
              delaycompress
              dateext
              dateformat -%Y%m%d
              rotate 7
              compress
              create 640 root root
              postrotate
                  /bin/kill -SIGUSR1 `cat /run/{{ item | basename }}.pid 2>/dev/null` 2>/dev/null || true
              endscript
          }
      loop: "{{ needed_fpm_files }}"
      when: needed_fpm_files | length > 0

    - name: Refresh fpm_files list including newly created files
      find:
        paths: /etc/logrotate.d
        patterns: 'plesk-php*-fpm'
      register: fpm_files_updated

    - name: Extract file paths of plesk-php*-fpm files
      set_fact:
        logrotate_php_fpm_files: "{{ fpm_files_updated.files | map(attribute='path') | list }}"

    - name: Create logrotate include config for Plesk PHP-FPM if files found
      copy:
        dest: /etc/logrotate.plesk-php.conf
        content: |
          {% for file in logrotate_php_fpm_files %}
          include {{ file }}
          {% endfor %}
      when: logrotate_php_fpm_files | length > 0

    - name: Remove logrotate include config if no plesk-php fpm files found
      file:
        path: /etc/logrotate.plesk-php.conf
        state: absent
      when: logrotate_php_fpm_files | length == 0

    - name: Create systemd service file if files found
      copy:
        dest: /etc/systemd/system/logrotate-plesk-php-fpm.service
        content: |
          [Unit]
          Description=Logrotate for Plesk PHP-FPM

          [Service]
          ExecStart=/usr/sbin/logrotate /etc/logrotate.plesk-php.conf
      when: logrotate_php_fpm_files | length > 0

    - name: Remove systemd service file if no files found
      file:
        path: /etc/systemd/system/logrotate-plesk-php-fpm.service
        state: absent
      when: logrotate_php_fpm_files | length == 0

    - name: Create systemd timer file if files found
      copy:
        dest: /etc/systemd/system/logrotate-plesk-php-fpm.timer
        content: |
          [Unit]
          Description=Daily log rotation for Plesk PHP-FPM

          [Timer]
          OnCalendar=daily
          Persistent=true

          [Install]
          WantedBy=timers.target
      when: logrotate_php_fpm_files | length > 0

    - name: Remove systemd timer file if no files found
      file:
        path: /etc/systemd/system/logrotate-plesk-php-fpm.timer
        state: absent
      when: logrotate_php_fpm_files | length == 0

    - name: Wait briefly to ensure systemd sees new unit files
      pause:
        seconds: 2
      when: logrotate_php_fpm_files | length > 0

    - name: Reload systemd to recognize new units if files found
      command: systemctl daemon-reexec
      when: logrotate_php_fpm_files | length > 0

    - name: Enable and start logrotate timer if files found
      systemd:
        name: logrotate-plesk-php-fpm.timer
        enabled: yes
        state: started
      when: logrotate_php_fpm_files |_
